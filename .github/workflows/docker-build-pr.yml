name: Build docker image

on:
  workflow_dispatch:
  pull_request:
    branches: [master]

jobs:
  build-pr:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: frontend

    steps:
      - uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build
        uses: docker/build-push-action@v3
        env:
          NODE_ENV: production
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        with:
          push: false
          target: production
          build-args: SENTRY_AUTH_TOKEN=$SENTRY_AUTH_TOKEN
          tags: ghcr.io/podkrepi-bg/frontend:pr
          outputs: image

      - name: Scan with Mondoo
        uses: mondoohq/actions@main
        with:
          service_account_credentials: ${{ secrets.MONDOO_SECRET }}
          scan_type: docker_image
          docker_image_name: ghcr.io/podkrepi-bg/frontend:pr
